# Pachca Welcome Bot

Бот для автоматического приветствия новых участников рабочего пространства в Пачке. Когда к рабочему пространству присоединяется новый участник, бот отправляет ему личное сообщение с приветствием.

## Особенности

- Автоматическое приветствие новых участников рабочего пространства
- Настраиваемые шаблоны приветственных сообщений (короткие, стандартные, расширенные)
- Персонализация сообщений с использованием имени пользователя
- Простая настройка через переменные окружения
- Безопасная обработка вебхуков с проверкой подписи
- Поддержка развертывания на Vercel, в Docker, локально или на собственном сервере

## Требования

- Ruby 3.0 или выше (рекомендуется Ruby 3.3.x)
- Bundler
- Доступ к API Пачки (токен доступа)
- Настроенный вебхук в Пачке
- Опционально: Docker и Docker Compose для запуска в контейнере

## Установка и настройка

### 1. Создание бота в Пачке

1. Войдите в свое рабочее пространство в Пачке
2. Перейдите в "Настройки" -> "Интеграции" -> "Боты"
3. Создайте нового бота, дайте ему имя (например, "Welcome Bot")
4. Получите токен доступа (access_token) для бота
5. Настройте исходящий вебхук для событий "Изменение состава участников пространства" и укажите URL вашего сервера (например, `https://your-server.com/webhook`)
6. Скопируйте секрет вебхука для проверки подписи

### 2. Локальная установка и запуск

1. Клонируйте репозиторий или скопируйте файлы проекта
2. Установите зависимости:

```bash
bundle install
```

3. Создайте файл `.env` на основе `.env.example` и заполните необходимые переменные:

```bash
cp .env.example .env
```

4. Отредактируйте файл `.env`, указав токен бота и секрет вебхука:

```
# Токен бота, полученный при создании бота в Пачке
PACHCA_TOKEN=your_bot_token_here
# Секрет вебхука, полученный при настройке вебхука
PACHCA_WEBHOOK_SECRET=your_webhook_secret_here
# Тип приветственного сообщения: default, short или extended
WELCOME_MESSAGE_TYPE=default
# Порт, на котором будет запущен сервер
PORT=3000
```

5. Запустите приложение:

```bash
bundle exec ruby app.rb
```

Для доступа из интернета вам потребуется настроить проксирование через Nginx/Apache или использовать сервисы типа ngrok или localtunnel для временного тестирования.

#### Использование localtunnel для тестирования

Localtunnel позволяет сделать ваш локальный сервер доступным из интернета без необходимости настройки портов или DNS:

1. Установите localtunnel через npm:

```bash
npm install -g localtunnel
```

2. Запустите ваш бот локально:

```bash
bundle exec ruby app.rb
```

3. В отдельном терминале запустите localtunnel, указав порт вашего приложения:

```bash
lt --port 3000
```

4. Localtunnel выдаст URL вида `https://something.loca.lt`. Используйте этот URL в настройках вебхука в Пачке, добавив путь `/webhook`:

```
https://something.loca.lt/webhook
```

5. Для тестирования можете временно отключить проверки безопасности, добавив в файл `.env`:

```
SKIP_SIGNATURE_VERIFICATION=true
SKIP_IP_VERIFICATION=true
SKIP_TIMESTAMP_VERIFICATION=true
```

### 3. Размещение на GitHub

Перед размещением кода на GitHub убедитесь, что вы не публикуете приватные данные:

1. Файл `.env` с токенами и секретами должен быть добавлен в `.gitignore`
2. Убедитесь, что в коде нет захардкоженных токенов или паролей
3. Файл `.env.example` должен содержать примеры переменных без реальных значений

#### Шаги по размещению на GitHub:

1. Создайте новый репозиторий на GitHub

2. Инициализируйте Git в папке проекта:

```bash
git init
git add .
git commit -m "Initial commit"
```

3. Добавьте удаленный репозиторий и отправьте код:

```bash
git remote add origin https://github.com/username/pachca-welcome-bot.git
git branch -M main
git push -u origin main
```

### 4. Развертывание на Vercel

#### С использованием веб-интерфейса Vercel (рекомендуется)

1. Зарегистрируйтесь или войдите в свой аккаунт на [Vercel](https://vercel.com)

2. Создайте файл `vercel.json` в корне проекта:

```json
{
  "version": 2,
  "builds": [
    { "src": "app.rb", "use": "@vercel/ruby" }
  ],
  "routes": [
    { "src": "/(.*)", "dest": "/app.rb" }
  ]
}
```

3. Импортируйте проект в Vercel:
   - Нажмите на кнопку "Import Project" на дашборде Vercel
   - Выберите ваш репозиторий или загрузите проект через опцию "Upload"

4. Настройте переменные окружения через веб-интерфейс:
   - На странице проекта перейдите во вкладку "Settings" → "Environment Variables"
   - Добавьте следующие переменные:
     - `PACHCA_TOKEN` (токен бота Пачки)
     - `PACHCA_WEBHOOK_SECRET` (секрет вебхука)
     - `WELCOME_MESSAGE_TYPE` (тип сообщения, например "default")
   - Нажмите "Save" для сохранения переменных

5. После успешного развертывания вы получите URL вашего приложения (например, `https://pachca-welcome-bot.vercel.app`)

6. Используйте этот URL для настройки вебхука в Пачке, добавив путь `/webhook`:
   ```
   https://pachca-welcome-bot.vercel.app/webhook
   ```

#### С использованием Vercel CLI (альтернативный способ)

1. Установите Vercel CLI:

```bash
npm install -g vercel
```

2. Войдите в свой аккаунт Vercel:

```bash
vercel login
```

3. Разверните приложение и следуйте инструкциям для настройки переменных окружения:

```bash
vercel
```

5. После успешного развертывания, обновите URL вебхука в настройках бота в Пачке на URL вашего приложения в Vercel.

### 4. Развертывание в Docker

Для удобства развертывания и изоляции зависимостей, бот можно запустить в Docker-контейнере. В проекте уже есть необходимые файлы `Dockerfile` и `docker-compose.yml`.

#### Запуск с использованием Docker Compose (рекомендуется)

1. Убедитесь, что у вас установлены Docker и Docker Compose

2. Создайте файл `.env` с необходимыми переменными окружения:

```bash
cp .env.example .env
```

3. Отредактируйте файл `.env`, указав токен бота и секрет вебхука

4. Запустите контейнер с ботом:

```bash
docker-compose up -d
```

5. Проверьте логи для отслеживания работы бота:

```bash
docker-compose logs -f
```

6. Для остановки бота:

```bash
docker-compose down
```

7. Настройка URL вебхука в Пачке:

При запуске в Docker бот будет доступен внутри вашей локальной сети, но не из интернета. Для настройки вебхука вам необходимо:

- **Для тестирования**: Используйте сервисы типа ngrok или localtunnel для создания публичного URL:
  ```bash
  ngrok http 3000
  # или
  lt --port 3000
  ```
  Используйте полученный URL в настройках вебхука Пачки: `https://your-ngrok-url/api`

- **Для продакшена**: Настройте проксирование через Nginx/Apache или другой веб-сервер с публичным IP-адресом или доменом.
  Например, для Nginx:
  ```
  location /api {
      proxy_pass http://localhost:3000;
      proxy_set_header Host $host;
      proxy_set_header X-Real-IP $remote_addr;
  }
  ```
  Используйте URL вашего домена в настройках вебхука Пачки: `https://your-domain.com/api`

#### Запуск с использованием Docker напрямую

1. Соберите Docker-образ:

```bash
docker build -t pachca-welcome-bot .
```

2. Запустите контейнер, указав необходимые переменные окружения:

```bash
docker run -d -p 3000:3000 \
  -e PACHCA_TOKEN=your_token_here \
  -e PACHCA_WEBHOOK_SECRET=your_webhook_secret_here \
  -e WELCOME_MESSAGE_TYPE=default \
  -v $(pwd)/messages.yml:/app/messages.yml \
  --name pachca-welcome-bot \
  pachca-welcome-bot
```

3. Просмотр логов:

```bash
docker logs -f pachca-welcome-bot
```

4. Остановка контейнера:

```bash
docker stop pachca-welcome-bot
```

5. Настройка URL вебхука в Пачке:

Так же как и при использовании Docker Compose, вам необходимо настроить публичный доступ к боту для получения вебхуков от Пачки. Используйте сервисы типа ngrok или настройте проксирование через веб-сервер. В настройках вебхука Пачки укажите URL: `https://your-domain-or-ngrok.com/api`

### 5. Развертывание на собственном сервере

1. Подготовьте сервер с установленным Ruby и Bundler
2. Скопируйте файлы проекта на сервер
3. Установите зависимости:

```bash
bundle install
```

4. Создайте файл `.env` с необходимыми переменными окружения
5. Настройте Nginx или Apache для проксирования запросов к приложению
6. Используйте systemd или другой менеджер процессов для запуска приложения в фоновом режиме

Пример конфигурации systemd (`/etc/systemd/system/pachca-welcome-bot.service`):

```
[Unit]
Description=Pachca Welcome Bot
After=network.target

[Service]
User=your_user
WorkingDirectory=/path/to/pachca-welcome-bot
ExecStart=/usr/local/bin/bundle exec ruby app.rb
Restart=always
Environment=RACK_ENV=production

[Install]
WantedBy=multi-user.target
```

Активация и запуск сервиса:

```bash
sudo systemctl enable pachca-welcome-bot
sudo systemctl start pachca-welcome-bot
```

## Настройка приветственных сообщений

### Выбор типа сообщения

Бот поддерживает три типа приветственных сообщений, которые можно выбрать, установив переменную окружения `WELCOME_MESSAGE_TYPE`:

- `default` - стандартное приветствие средней длины (используется по умолчанию)
- `extended` - расширенное приветствие с дополнительной информацией и ссылками
- `short` - короткое приветствие в одну строку

### Настройка текста сообщений

Текст приветственных сообщений настраивается в файле `messages.yml`. Этот файл находится в корневой папке проекта и имеет формат YAML.

Для изменения текста сообщений:

1. Откройте файл `messages.yml` в любом текстовом редакторе
2. Измените текст сообщений для нужных типов (`short`, `default`, `extended`)
3. Сохраните файл и перезапустите бота

В шаблонах сообщений вы можете использовать следующую переменную:

- `{{name_greeting}}` - обращение по имени (например, ", Иван")

Пример файла `messages.yml`:

```yaml
# Шаблоны приветственных сообщений для Welcome Bot

# Короткое приветствие
short: |
  👋 Привет{{name_greeting}}! Добро пожаловать в наше рабочее пространство Пачки!

# Стандартное приветствие (по умолчанию)
default: |
  # 👋 Добро пожаловать в наше рабочее пространство{{name_greeting}}!
  
  Мы рады видеть вас в нашей команде! {{title_info}}Если у вас возникнут вопросы, не стесняйтесь обращаться к администраторам или коллегам.
```

Вы можете использовать форматирование Markdown в тексте сообщений, включая ссылки, списки и выделение текста.

## Безопасность

Бот реализует следующие меры безопасности:

- Аутентификация через токены API Пачки
- Хранение токенов в переменных окружения (не в коде)
- Проверка подписи вебхуков с использованием HMAC SHA256
- Проверка времени вебхука для предотвращения replay-атак
- Валидация IP-адреса отправителя вебхуков
- Использование HTTPS для всех запросов
- Минимальные необходимые права для бота
- Логирование событий с маскированием чувствительных данных

## Устранение неполадок

### Бот не отправляет приветственные сообщения

1. Убедитесь, что токен бота действителен и имеет необходимые права
2. Проверьте, что вебхук правильно настроен в Пачке и указывает на корректный URL
3. Проверьте логи сервера на наличие ошибок
4. Убедитесь, что событие `confirm` для новых пользователей корректно обрабатывается

### Проблемы с безопасностью вебхуков

1. **Проверка подписи**:
   - Убедитесь, что `PACHCA_WEBHOOK_SECRET` соответствует секрету в настройках вебхука в Пачке (Signing secret)
   - Проверьте, что заголовок `pachca-signature` правильно передается в запросе
   - Для отладки можно временно отключить проверку подписи: `SKIP_SIGNATURE_VERIFICATION=true`

2. **Проверка IP-адреса**:
   - Если вы используете прокси или CDN, убедитесь, что вы получаете реальный IP-адрес Пачки (37.200.70.177)
   - Для отладки можно временно отключить проверку IP: `SKIP_IP_VERIFICATION=true`

3. **Проверка времени вебхука**:
   - Убедитесь, что время на сервере синхронизировано
   - Для отладки можно временно отключить проверку времени: `SKIP_TIMESTAMP_VERIFICATION=true`

**Важно**: Все отключения проверок безопасности следует использовать только для отладки и не рекомендуется для продакшена.

## Лицензия

MIT
